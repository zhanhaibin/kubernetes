upstream backend {
  server c00002-05-svc.ibas-platform.svc.cluster.local:80;
}
server {
        listen       80;
        server_name  api.avacloud.com.cn; 
        
        location /test {
           resolver 223.5.5.5 223.6.6.6;
           content_by_lua_block{ 
             local httpUri = ngx.var.request_uri
             local str = string.sub(httpUri,1,14)
 	     local httpHost = 'https://api.avacloud.com.cn'
	     local uri = ''
	     uri = httpHost..str
    
             local res = ngx.location.capture(uri)                    
             if res.status == 404 then        
                --ngx.exec("/vstore")
                local res2 = ngx.location.capture("/vstore")
                ngx.say("statusssss:"..res2)
                --if status == 200 then
                --  ngx.exec("/vstore")
                --end
             end
	   }
        }

        location /api {
           resolver 223.5.5.5 223.6.6.6;
           content_by_lua_block{
                local httpUri = ngx.var.request_uri
                local httpHost = 'https://api.avacloud.com.cn'
                local uri = ''
                uri = httpHost..httpUri
                ngx.say("httpuri:"..uri)
                --local res = ngx.location.capture(uri)
                --ngx.status = res.status
                --ngx.say("service:"..ngx.status);
                }
        }
        
        location / {
           default_type text/html;
           resolver 223.5.5.5 223.6.6.6;  # 这里位设置阿里的DNS，不设置DNS无法解析http请求的域名
           content_by_lua_file lua/vstore.lua;
        }
        
        location ~ /lua/(.+) {
           default_type text/html;
           resolver 223.5.5.5 223.6.6.6;  # 这里位设置阿里的DNS，不设置DNS无法解析http请求的域名
           content_by_lua_file lua/$1.lua;
        }
        # 默认访问本地文件

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
  }
